
## [19:40] Outliner and Combination System
*(Self-Correction & Refinement)*

**Feature:** Implemented an "Outliner" window (replacing the Test Window) to list active objects and combinations, with grouping and renaming capabilities.

**Changes:**
1.  **Outliner Implementation**:
    -   Converted "Test Window" to "Outliner".
    -   Lists all active cubes ("cube_001", etc.).
    -   Shows combinations (groups of connected cubes) with expand/collapse functionality.
    -   Implemented a "Combination" system where pressing 'C' groups connected cubes.
    -   Combined cubes are hidden from the top-level list and shown under their combination.

2.  **ImGui Integration Challenges & Fixes**:
    -   **String Handling**: Fixed `std::string` vs `const char*` issues in generated C++ code by modifying the transpiler to automatically append `.c_str()` when necessary.
    -   **Crash Fix (g.WithinFrameScope)**: Fixed a persistent crash when initiating rename. The issue was caused by calling ImGui functions outside the valid frame scope or in an invalid state.
        -   **Solution**: Implemented a "bulletproof" input text handling pattern.
        -   Used `ImGuiInputTextFlags_EnterReturnsTrue` and `ImGuiInputTextFlags_AutoSelectAll`.
        -   Ensured proper focus management with `ImGui::SetKeyboardFocusHere(0)`.
        -   Added robust exit conditions (Escape key or clicking outside the window).
        -   Deferred the start of editing to the next frame to prevent frame-scope conflicts.

3.  **Persistence**:
    -   Updated `heidic_save_level` and `heidic_load_level` to store and retrieve custom combination names in `.eden` files.
    -   Added `COMBINATION_NAMES` section to the file format.

**Note:** The Outliner implementation was removed due to persistent issues with duplicate Begin() calls and ImGui state management. Will be reimplemented from scratch with a simpler approach.

---

## [Late Night] Texture Batching and Vertex Buffer Offset Fix
*(Major Bug Fix - Blocks Disappearing When Switching Textures)*

**Problem:** When switching textures and placing new blocks, previously placed blocks would disappear or render with incorrect textures. The issue manifested as:
- Blocks vanishing completely when placing a new block with a different texture
- Blocks requiring multiple placements before the new texture would appear
- Previous blocks disappearing one-by-one as new blocks were placed

**Root Causes Identified:**
1. **Texture Destruction**: Textures were being destroyed/recreated each frame, causing old batches to reference invalid texture resources
2. **Vertex Buffer Overwrites**: All batches were writing to the same memory region in the vertex buffer, causing later batches to overwrite earlier ones
3. **Descriptor Set Synchronization**: Descriptor sets were being updated while still in use by the GPU

**Solutions Implemented:**

1. **Texture Caching System**:
   - Introduced `TextureResource` struct and `g_textureCache` map to store loaded textures
   - Modified `heidic_load_texture_for_rendering()` to check cache first before loading
   - Textures now persist throughout their lifetime, preventing destruction of resources still in use
   - Removed texture destruction logic that was causing invalid references

2. **Per-Batch Descriptor Sets**:
   - Implemented `g_batchDescriptorSets` as a 2D vector (frames Ã— batches) to allow multiple textures per frame
   - Each batch gets its own descriptor set, allowing different textures to be bound for different draw calls
   - Added `g_currentBatchIndex` to track which descriptor set to use for each batch

3. **Vertex Buffer Offsets**:
   - **Critical Fix**: Implemented buffer offset system within a single large vertex buffer (`g_coloredCubeVertexBuffer`)
   - Increased buffer size to 100MB to accommodate multiple batches
   - Each batch writes to a distinct 10MB region: `batchOffset = batchIndex * (10 * 1024 * 1024)`
   - `vkCmdBindVertexBuffers()` now uses the calculated `batchOffset` to draw from the correct memory region
   - This prevents batches from overwriting each other's vertex data

4. **Vulkan Synchronization Improvements**:
   - Fixed fence/semaphore usage in `heidic_begin_frame()` and `heidic_end_frame()`
   - Ensured proper waiting on `g_inFlightFence` before resetting
   - Switched image acquisition to use semaphores instead of fences
   - Descriptor set updates now occur before binding, ensuring they're safe during command buffer recording

**Technical Details:**
- Buffer offset calculation: `VkDeviceSize batchOffset = batchIndex * (10 * 1024 * 1024)`
- Each batch can store up to ~1.7 million vertices (10MB / 6 bytes per vertex)
- Maximum of 10 batches per frame (100MB total buffer / 10MB per batch)
- Texture cache prevents redundant loading and ensures resource validity

**Result:** Blocks now correctly maintain their textures when switching between different textures. Multiple blocks with different textures can coexist and render correctly in the same frame without disappearing or overwriting each other.
